{% extends "base.html" %}


{% comment %} 
{% load static %}
{% block title %}{{ playlist.name }}{% endblock %}
{% block content %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/playlist_detail.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock style %}

<div class="playlist-cov-con" style="background: linear-gradient(to top, black 10%, {{ playlist.top_color }});">
  <div class="back-btn-con">
    <button class="back-btn"><a href="{% url 'playlist' %}">&lt; Back</a></button>
  </div>

  <div class="playlist-cover">
    {% with songs=playlist.songs.all|slice:":4" %}
      {% if songs %}
        {% for song in songs %}
          <img src="{{ song.cover_image.url }}" alt="{{ song.song_name }}">
        {% endfor %}
      {% else %}
        <img src="{% static 'images/default_playlist.jpg' %}" alt="Default Playlist">
      {% endif %}
    {% endwith %}
  </div>
</div>

<!-- Add Songs Button -->
<div style="text-align:center;margin-top:30px;">
  <a href="{% url 'add_songs' playlist.id %}" class="add-btn">Add Songs</a>
</div>

<!-- Songs in Playlist -->
<div class="playlist-con">
  <div class="playlist-details">
    <div>
      <h1 style="color:white;">{{ playlist.name }}</h1>
      <p style="color:#bbb;">
        {{ playlist.songs.count }} song{{ playlist.songs.count|pluralize:"s" }}
        featuring music and vocals like {{ limited_artists|join:", " }}
      </p>
    </div>
    <div class="fa-play-con">
      <i id="playlistPlayBtn"  class="fa-solid fa-play"></i>
      <i class="fa-solid fa-pause"></i>
    </div>
  </div>

  <div class="song-list">
    {% for song in songs %}
    <div class="song-card" data-audio="{{ song.audio_file.url }}">
      <img src="{{ song.cover_image.url }}" alt="{{ song.song_name }}">
      <div class="song-info">
        <h3>{{ song.song_name }}</h3>
        <p>{{ song.movie_title }} â€¢ {{ song.artist }}</p>
      </div>

      <!-- 3-dot menu -->
    <div class="menu-container">
      <button class="menu-btn">â‹®</button>
      <div class="menu-dropdown">
        <form method="POST" action="{% url 'remove_from_playlist' playlist.id song.id%}">
          {% csrf_token %}
          <button type="submit" class="delete-btn">Remove</button>
        </form>
      </div>
    </div>
    </div>
    {% empty %}
    <p style="color:gray;">No songs in this playlist yet.</p>
    {% endfor %}
  </div>
</div>

<!-- Hidden audio player -->
<audio id="audioPlayer" controls style="display:none;"></audio>

<script>
 // ðŸŽµ Play song on click
const audioPlayer = document.getElementById("audioPlayer");
document.querySelectorAll(".song-card").forEach(card => {
  card.addEventListener("click", (e) => {
    // Ignore clicks on menu or remove
    if (e.target.classList.contains("menu-btn") || e.target.classList.contains("delete-btn")) return;

    const audioSrc = card.dataset.audio;
    if (audioPlayer.src !== audioSrc) {
      audioPlayer.src = audioSrc;
      audioPlayer.play();
    } else {
      if (audioPlayer.paused) audioPlayer.play();
      else audioPlayer.pause();
    }
  });
});

// --- 3-dot menu ---
document.querySelectorAll('.menu-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    e.stopPropagation();
    closeAllMenus();
    btn.nextElementSibling.classList.toggle('show');
  });
});

function closeAllMenus() {
  document.querySelectorAll('.menu-dropdown').forEach(menu => menu.classList.remove('show'));
}

window.addEventListener("click", closeAllMenus);


const playBtn = document.getElementById("playlistPlayBtn");
const audioPlayer = document.getElementById("audioPlayer");
const songCards = Array.from(document.querySelectorAll(".song-card"));
let currentIndex = 0;
let isPlaying = false;

// Function to play current song
function playSong(index) {
  const song = songCards[index];
  if (!song) return;

  const audioSrc = song.dataset.audio;
  audioPlayer.src = audioSrc;
  audioPlayer.play();
  isPlaying = true;
  playBtn.classList.replace("fa-play", "fa-pause");
}

// Function to play next song automatically
audioPlayer.addEventListener("ended", () => {
  currentIndex++;
  if (currentIndex < songCards.length) {
    playSong(currentIndex);
  } else {
    isPlaying = false;
    playBtn.classList.replace("fa-pause", "fa-play");
  }
});

// Play/Pause Playlist
playBtn.addEventListener("click", () => {
  if (!isPlaying) {
    // Start from first song if not playing
    if (audioPlayer.paused && !audioPlayer.src) {
      currentIndex = 0;
      playSong(currentIndex);
    } else {
      audioPlayer.play();
      playBtn.classList.replace("fa-play", "fa-pause");
    }
  } else {
    audioPlayer.pause();
    playBtn.classList.replace("fa-pause", "fa-play");
    isPlaying = false;
  }
});

</script>

{% endblock %} {% endcomment %}


{% load static %}

{% block title %}{{ playlist.name }}{% endblock %}
{% block content %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/playlist_detail.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock style %}

<!-- Playlist Cover -->
<div class="playlist-cov-con" style="background: linear-gradient(to top, black 10%, {{ playlist.top_color }});">
  <div class="back-btn-con">
    <button class="back-btn"><a href="{% url 'playlist' %}">&lt; Back</a></button>
  </div>

  <div class="playlist-cover">
    {% with songs=playlist.songs.all|slice:":4" %}
      {% if songs %}
        {% for song in songs %}
          <img src="{{ song.cover_image.url }}" alt="{{ song.song_name }}">
        {% endfor %}
      {% else %}
        <img src="{% static 'images/default_playlist.jpg' %}" alt="Default Playlist">
      {% endif %}
    {% endwith %}
  </div>
</div>

<!-- Add Songs Button -->
<div style="text-align:center;margin-top:30px;">
  <a href="{% url 'add_songs' playlist.id %}" class="add-btn">Add Songs</a>
</div>

<!-- Playlist Details and Songs -->
<div class="playlist-con">
  <div class="playlist-details">
    <div>
      <h1 style="color:white;">{{ playlist.name }}</h1>
      <p style="color:#bbb;">
        {{ playlist.songs.count }} song{{ playlist.songs.count|pluralize:"s" }}
        featuring music and vocals like {{ limited_artists|join:", " }}
      </p>
    </div>
    <div class="fa-play-con">
      <i id="playlistPlayBtn" class="fa-solid fa-play"></i>
    </div>
  </div>

  <div class="song-list">
    {% for song in songs %}
    <div class="song-card" data-audio="{{ song.audio_file.url }}">
      <img src="{{ song.cover_image.url }}" alt="{{ song.song_name }}">
      <div class="song-info">
        <h3>{{ song.song_name }}</h3>
        <p>{{ song.movie_title }} â€¢ {{ song.artist }}</p>
      </div>

      <!-- 3-dot menu -->
      <div class="menu-container">
        <button class="menu-btn">â‹®</button>
        <div class="menu-dropdown">
          <form method="POST" action="{% url 'remove_from_playlist' playlist.id song.id %}">
            {% csrf_token %}
            <button type="submit" class="delete-btn">Remove</button>
          </form>
        </div>
      </div>
    </div>
    {% empty %}
    <p style="color:gray;">No songs in this playlist yet.</p>
    {% endfor %}
  </div>
</div>

<!-- Hidden audio player -->
<audio id="audioPlayer" controls style="display:none;"></audio>

<!-- JS -->
<script>
const audioPlayer = document.getElementById("audioPlayer");
const playBtn = document.getElementById("playlistPlayBtn");
const songCards = Array.from(document.querySelectorAll(".song-card"));
let currentIndex = 0;
let isPlaying = false;

// ðŸŽµ Play individual song on click
songCards.forEach((card, index) => {
  card.addEventListener("click", (e) => {
    if (e.target.classList.contains("menu-btn") || e.target.classList.contains("delete-btn")) return;

    const audioSrc = card.dataset.audio;
    if (audioPlayer.src !== audioSrc) {
      audioPlayer.src = audioSrc;
      audioPlayer.play();
      isPlaying = true;
      playBtn.classList.replace("fa-play", "fa-pause");
      currentIndex = index;
      highlightPlayingSong(index);
    } else {
      if (audioPlayer.paused) {
        audioPlayer.play();
        playBtn.classList.replace("fa-play", "fa-pause");
      } else {
        audioPlayer.pause();
        playBtn.classList.replace("fa-pause", "fa-play");
      }
    }
  });
});

// ðŸŽ¶ Playlist play/pause logic
function playSong(index) {
  const song = songCards[index];
  if (!song) return;
  const audioSrc = song.dataset.audio;
  audioPlayer.src = audioSrc;
  audioPlayer.play();
  isPlaying = true;
  playBtn.classList.replace("fa-play", "fa-pause");
  highlightPlayingSong(index);
}

audioPlayer.addEventListener("ended", () => {
  currentIndex++;
  if (currentIndex < songCards.length) playSong(currentIndex);
  else {
    isPlaying = false;
    playBtn.classList.replace("fa-pause", "fa-play");
  }
});

playBtn.addEventListener("click", () => {
  if (!isPlaying) {
    if (audioPlayer.paused && !audioPlayer.src) {
      currentIndex = 0;
      playSong(currentIndex);
    } else {
      audioPlayer.play();
      playBtn.classList.replace("fa-play", "fa-pause");
    }
  } else {
    audioPlayer.pause();
    playBtn.classList.replace("fa-pause", "fa-play");
    isPlaying = false;
  }
});

// Highlight currently playing song
function highlightPlayingSong(index) {
  songCards.forEach(card => card.classList.remove("playing"));
  if (songCards[index]) songCards[index].classList.add("playing");
}

// 3-dot menu
document.querySelectorAll('.menu-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    e.stopPropagation();
    closeAllMenus();
    btn.nextElementSibling.classList.toggle('show');
  });
});

function closeAllMenus() {
  document.querySelectorAll('.menu-dropdown').forEach(menu => menu.classList.remove('show'));
}
window.addEventListener("click", closeAllMenus);
</script>

{% endblock %}
